"use strict";!function(l){l.svgReport={ctr:0,total:0,questionSet:[],confettiIds:[{countryId:1,courseIds:[1,2,3,4,5,6,7]},{countryId:3,courseIds:[1,2,3,4,5,6,7]},{countryId:4,courseIds:[1,2,3,4,5,6,7,8,9,10,11,12,13]},{countryId:8,courseIds:[1,2,3,4,5,6,7,8,9,10,11,12,13]}],countryId:0,courseId:0,perfectScore:!1,passed:!1,target:null,targetContainer:null,copyright:"",standalone:!1,reportName:"",fullName:"",ajaxDataString:"",styleOverridePrintArea:"",styleOverrideNotification:"",converted:!1,buttons:{pdf:l("#svg_report_pdf"),print:l("#svg_report_print"),retry:l("#svg_report_retry"),continue:l("#svg_report_continue")},panels:{progress:l("#svg_report__progress"),printArea:l("#svg_report_printarea"),download:l("#svg_report__download"),notification:l("#svg_report_notification")},bars:{progress:l("#svg_report__progress-value")},progress:{bar:l("#svg_report__progress-bar"),value:l("#svg_report__progress-value"),message:l("#svg_report__progress-bar + h2"),grade:l("#svg_report__progress > div:first-child")},generate:function(s){var d=this;d.reset(),d.standalone="true"===s.standalone,d.target=s.target,d.targetContainer=s.targetContainer,d.target.css("overflow-y","hidden"),d.target.css("width","100%"),d.copyright=s.copyright,d.reportName=s.reportName,d.converted=!1,d.isIEorEdge()&&l("#svg_report_pdf").hide(),null!==s.styleOverridePrintArea&&""!==s.styleOverridePrintArea&&(d.styleOverridePrintArea=s.styleOverridePrintArea),null!==s.styleOverrideNotification&&""!==s.styleOverrideNotification&&(d.styleOverrideNotification=s.styleOverrideNotification);d.standalone&&l("#svg-ui__completed").html('<div id="svg_report__progress"><div id="progress-container"><div><img src="/assets/images/loading.gif" /></div></div></div>'),d.panels.download.hide(),d.panels.progress.show(),d.target.trigger("report.progress",[0]),d.target.on("report.progress",function(e,a){d.progress.value.css("width",a+"%"),100==a&&(l(".svg-ui__block").css("height","800px"),d.panels.progress.hide(),d.progress.value.css("width","0%"),d.buttons.print.on("click",function(e){var t=["/assets/dist/css/interactives/svg/svg_report.min.css?v="+appVersion,"/assets/applications/interactives/css/main.css"];1==d.converted&&(t=["/assets/dist/css/interactives/svg/svg_report_image.min.css?v="+appVersion,"/assets/applications/interactives/css/main.css"]),e.preventDefault(),d.panels.printArea.printThis({printDelay:2e3,importCSS:!1,canvas:!0,loadCSS:t,footer:'<div id="svg_report_footer" class="text-center">'+d.copyright+"</div>"})}),d.buttons.pdf.click(function(e){if(e.preventDefault(),d.panels.download.hide(),l("body").trigger("report.conversion",["started"]),0==d.converted&&0==d.isIEorEdge()){var i=d;d.target.attr("style","overflow-y: hidden"),d.progress.grade.hide(),d.panels.progress.show(),d.progress.message.html('<i class="fa fa-circle-o-notch fa-spin fa-fw text-success" aria-hidden="true"></i> Converting report to PDF...'),d.progress.bar.show(),l("#progress-container").show(),d.target.on("report.progress",function(e,t){d.progress.value.css("width",t+"%"),100==t&&(d.target.attr("style","z-index: 700; overflow-y: auto; width: 100%;"),d.converted=!0,d.progress.message.html('<i class="fa fa-check text-success" aria-hidden="true"></i> Conversion done!'),d.target.unbind("report.progress"),setTimeout(function(){d.panels.progress.hide()},1e3),setTimeout(function(){d.downloadPdf("image")},2e3))}),l.each(l(".q-svg"),function(){var t,n=l(this).index();(t=500*n,new Promise(function(e){return setTimeout(e,t)})).then(function(){var r=l("#id-"+n),s=l("#id-"+n+" .q-id-container").clone();l("#id-"+n+" .q-id-container").remove();var e=r.find("svg"),t=e.attr("viewBox").split(" "),o=t[2];t[3];r.css({width:o,border:0}),e.css({top:"-10px",left:"-5px",padding:0,margin:0}),domtoimage.toPng(r[0]).then(function(e){var t=new Image;t.src=e,450<o?t.setAttribute("style","width: 85%;"):t.width=o,r.empty(),r.append(s),r.append(t),r.css({width:"100%","border-bottom":"1px dashed #ccc","break-inside":"avoid-column","page-break-inside":"avoid"}),a=(n+1)/(d.total-1)*100,i.target.trigger("report.progress",[a]),100==a&&l("body").trigger("report.conversion",["completed"])})})})}else d.downloadPdf("svg")}))});var e={userId:s.userId,userQuestionSetId:s.userQuestionSetId,standalone:s.standalone,styleOverridePrintArea:d.styleOverridePrintArea,styleOverrideNotification:d.styleOverrideNotification,finalStat:s.finalStat};d.ajaxDataString=JSON.stringify(e),d.buttons.retry.hide(),d.buttons.continue.hide();l.ajax({type:"POST",url:"/ajax/svg_interactives/getSvgResult",data:e,timeout:3e4,dataType:"json",tryCount:0,retryLimit:3,success:function(e,t,r){d.total=e.total,d.questionSet=e.interactives,d.perfectScore=e.perfectScore,d.passed=e.passed,d.courseId=parseInt(e.courseId),d.countryId=parseInt(e.countryId),d.reportName=e.lessonCaption,d.fullName=e.fullName,d.converted=!1,l.when(d.target.empty().append(e.result)).then(function(){d.panels={progress:l("#svg_report__progress"),printArea:l("#svg_report_printarea"),download:l("#svg_report__download"),notification:l("#svg_report_notification")},d.bars={progress:l("#svg_report__progress-value")},d.progress={bar:l("#svg_report__progress-bar"),value:l("#svg_report__progress-value"),message:l("#svg_report__progress-bar + h2"),grade:l("#svg_report__progress > div:first-child")},d.buttons={pdf:l("#svg_report_pdf"),print:l("#svg_report_print"),retry:l("#svg_report_retry"),continue:l("#svg_report_continue")},d.standalone?(l("#svg_report_notification").css("display","none"),setTimeout(function(){d.reconstruct()},300)):(d.passed&&d.perfectScore&&d.showConfetti(),l("#svg_report__final").hide(),l("#progress-container").hide(),l("#svg_report_generate").click(function(e){e.preventDefault(),l("#confetti").fadeOut(1e3,function(){l(this).remove()}),l("#resultModalBody").empty(),l("<iframe>",{src:"/students/lesson/"+s.userQuestionSetId,frameborder:0,id:"lessonResultModalIframe",style:"width: 100%; height: 100%; border: 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0"}).appendTo("#resultModalBody"),(1e3<l(".nav-tabs").width()||1e3<l(".section-title").width())&&l(".individual-result-modal").css("width","1000px"),l("#lessonResultModal").removeClass("fade").addClass("in").css("display","block"),l("[data-dismiss=modal], .modal.in").click(function(e){l("#lessonResultModal").addClass("fade in").css("display","none")})}),d.buttons.retry.on("click",function(e){e.preventDefault(),d.reset(),d.target.unbind(),d.target.empty(),d.targetContainer.css("z-index",0),l("#svg_report_notification").css("display","none"),l(".svg-ui").trigger("svg.ui.event",["restart"])}))})},error:function(e,t,r){var s=this;setTimeout(function(){if(s.tryCount++,s.tryCount<=s.retryLimit)var e=setInterval(function(){0<t?t--:(clearInterval(e),l.ajax(s))},1e3),t=3;else;},1e3)}})},showConfetti:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){var t=this;0<this.confettiIds.filter(function(e){return e.countryId===t.countryId&&-1!=e.courseIds.indexOf(t.courseId)}).length&&(showConfetti(),l("#confetti").css("z-index",100),this.targetContainer.css("z-index",1e3),l("#confetti").click(function(e){l(this).fadeOut(1e3,function(){l(this).remove()})}))}),reconstruct:function(){var n=this;requirejs(["app/app"],function(o){function e(e){try{var t=document.getElementById("id-"+e),r=n.questionSet[e],s={mode:"3",interactive:JSON.stringify(r.interactive),components:JSON.stringify(r.components),reconstruct:r.answer,version:16,DEBUG:!1};o.init(t,s)}catch(e){}}var t=0;o.EventManager.subscribe(o.CONST.EVENT_QUESTION_READY_TO_PRINT,function(){n.ctr;n.ctr<n.total-1?(n.ctr++,t=n.ctr/(n.total-1)*100,n.target.trigger("report.progress",[t]),setTimeout(function(){e(n.ctr)},500)):(n.panels.progress.hide(),l("#svg_report_print").show(),l("#svg_report_pdf").show(),l("#svg_report_generate").hide(),o.EventManager.reset(),n.target.css("overflow-y","auto"),n.target.unbind())}),t=n.ctr/(n.total-1)*100,n.target.trigger("report.progress",[t]),e(n.ctr)})},reset:function(){this.ctr=0,this.questionSet=[],this.countryId=0,this.courseId=0,this.passed=!1,this.perfectScore=!1,this.total=0,this.standalone=!1},downloadPdf:function(e){var r=this,t=new Date,s=""+(t.getMonth()+1),o=""+t.getDate(),n=t.getFullYear();s.length<2&&(s="0"+s),o.length<2&&(o="0"+o);var i=n+s+o,a=Math.round(Math.pow(36,5)-Math.random()*Math.pow(36,4)).toString(36).slice(1),d=this.reportName;d=d.replace(/ +/g,"");var c=this.fullName+"_"+d+"_"+i+"_"+a,p={url:"/ajax/svg_interactives/saveAsPDF",method:"POST",data:{mode:e,content:l("#svg_report_printarea").html(),reportName:c,copyright:'<div id="svg_report_footer" class="text-center">'+this.copyright+"</div>"}};r.panels.download.html("Downloading PDF..."),r.panels.download.fadeIn();var g=l.ajax(p);setTimeout(function(){g.done(function(e){var t=e.url;setTimeout(function(){var e=document.createElement("a");e.href=t,e.setAttribute("download","download"),document.body.appendChild(e),e.click(),e.parentNode.removeChild(e),r.panels.download.fadeOut()},300)}).fail(function(){r.panels.download.hide();r.panels.download.html('<h3>Error downloading PDF</h3><div style="font-size: 1.75rem; padding: 5px 25px;">An error occured while generating and downloading the PDF. Alternatively, you can use the print button and save the preview as PDF or you may try again.</div>'),r.panels.download.fadeIn(),setTimeout(function(){r.panels.download.fadeOut()},5e3)})},2500)},isIEorEdge:function(){var e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(0<t)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);if(0<e.indexOf("Trident/")){var r=e.indexOf("rv:");return parseInt(e.substring(r+3,e.indexOf(".",r)),10)}var s=e.indexOf("Edge/");return 0<s&&parseInt(e.substring(s+5,e.indexOf(".",s)),10)}}}(jQuery);